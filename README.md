# ğŸŒ GIS å¯è§†åŒ–ä¸ç©ºé—´åˆ†æå¹³å°
## ğŸš€ é¡¹ç›®æŒ‡ä»¤
#### å¯åŠ¨é¡¹ç›®

```bash
pnpm run dev
```
#### æ„å»ºé¡¹ç›®
```bash
pnpm run build
```

#### è¿è¡Œé¡¹ç›®
```bash
pnpm run start
```

#### è¿è¡Œæµ‹è¯•
```bash
pnpm run test
```
---
## ğŸ“Œ é¡¹ç›®ä»‹ç»
è¿™æ˜¯ä¸€ä¸ªåŸºäº Web çš„ GIS å¯è§†åŒ–å’Œç©ºé—´åˆ†æå¹³å°ï¼Œé›†æˆäº† Agent æ™ºèƒ½ä½“åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- å¤šæºåº•å›¾åŠ è½½ä¸åˆ‡æ¢
- æ˜¼å¤œæ¨¡å¼åˆ‡æ¢
- åœ°å›¾çŠ¶æ€ç®¡ç†
- æ•°æ®å¤„ç†ä¸åˆ†æ
- GISæ™ºèƒ½ä½“åˆ†æ

## ğŸ› ï¸ æŠ€æœ¯æ ˆ
- å‰ç«¯æ¡†æ¶: React (æ ¹æ®å®é™…é¡¹ç›®å¡«å†™)
- æ ·å¼æ¡†æ¶: Ant Design
- çŠ¶æ€ç®¡ç†: Zustand
- æ„å»ºå·¥å…·: pnpm
- GIS å¼•æ“: GeoScene API for JavaScript
- ç©ºé—´åˆ†æå·¥å…·: Turf

## ğŸ“¦ å…·ä½“åŠŸèƒ½
- é€†åœ°ç†ç¼–ç ï¼šç‚¹å‡»åœ°å›¾ä¸Šçš„ç‚¹è¿›è¡Œé€†åœ°ç†ç¼–ç 
- è·å–å¤©æ°”ï¼šé€šè¿‡è§†å›¾ä¸­å¿ƒç‚¹è·å–å¤©æ°”
- çŸ¢é‡è¦ç´ ç±»
  - é€šè¿‡geoserverç®¡ç†
  - åŠ è½½çŸ¢é‡è¦ç´ ç±»
  - çŸ¢é‡è¦ç´ å¼¹æ¡†æ˜¾ç¤ºå¯ä»¥ç¼–è¾‘æ•°æ®æˆ–åˆ é™¤
  - çŸ¢é‡è¦ç´ å¼¹æ¡†å¯ä»¥è®¾ç½®ç¼–è¾‘å½¢çŠ¶å’Œä½ç½®
  - åˆ†å‰²çº¿åˆ‡å‰²
  - ä¸Šä¼ shpæ–‡ä»¶åŠ è½½ï¼ˆåç«¯å¤„ç†ï¼‰
  - ä¸Šä¼ geojsonæ–‡ä»¶åŠ è½½ï¼ˆåç«¯å¤„ç†ï¼‰
- å›¾å±‚åˆ—è¡¨
  - æŸ¥çœ‹å›¾å±‚å±æ€§
  - å›¾å±‚çš„å­—æ®µåˆ—è¡¨
  - å›¾å±‚çš„è¦ç´ è¾¹æ¡†å’Œé¢œè‰²çš„æ¸²æŸ“
  - å›¾ä¾‹çš„æ¸²æŸ“
- ç©ºé—´åˆ†æåˆ†æ
  - ç¼“å†²åŒºåˆ†æ(turf)
  - æœç´¢åœ°å€
  -  

## ğŸ”— ç›¸å…³èµ„æº
- [GeoScene API for JavaScript æ–‡æ¡£](https://doc.geoscene.cn/javascript/4.29/api-reference/index.html)
- [Antdesignæ–‡æ¡£](https://ant.design/components/overview-cn)
- [å›¾æ ‡åº“](https://www.iconfont.cn/)
- [é«˜å¾·åŠ¨å›¾APIæ–‡æ¡£](https://lbs.amap.com/api/webservice/summary)
- [DataV.GeoAtlasåœ°ç†å°å·¥å…·ç³»åˆ—](https://datav.aliyun.com/portal/school/atlas/area_selector)
- [Arcgis apiå­¦ä¹ -å“”å“©å“”å“©è§†é¢‘](https://space.bilibili.com/326281584?spm_id_from=333.337.0.0)
- [GeoScene Online](https://www.geosceneonline.cn/geoscene/webapps/mapViewer)
- [geojson.io | powered by Mapbox](https://geojson.io/#map=2/0/20)
- [DeepSeek - æ¢ç´¢æœªè‡³ä¹‹å¢ƒ](https://chat.deepseek.com/)
- [å¤©åœ°å›¾ æœåŠ¡ä¸­å¿ƒ geojsonä¸‹è½½](https://cloudcenter.tianditu.gov.cn/administrativeDivision/)
- [ä¸ªäººBlogs: Liao-dorian`s blogs](https://gitee.com/Liao-dorian/myblogs)
- [å‚è€ƒMyé¡¹ç›®](https://gitee.com/Liao-dorian/umijs-load-map)
- [35ä¸ªåœ¨çº¿åœ°å›¾ç“¦ç‰‡URLåˆ†äº«_åœ¨çº¿åœ°å›¾æ¥å£-CSDNåšå®¢](https://blog.csdn.net/mrib/article/details/141326671)
- [å“”å“©å“”å“© (ã‚œ-ã‚œ)ã¤ãƒ­ å¹²æ¯~-bilibili](https://www.bilibili.com/)
- [å¿«é€Ÿä¸Šæ‰‹ - SiliconFlow](https://docs.siliconflow.cn/cn/userguide/quickstart)
- [Agent  å­¦ä¹   å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1g4E4zsEoY/?spm_id_from=333.788.player.switch&vd_source=3c46a0d84476a55380be0c2ddd012af1&p=2)

## ğŸ“… å‰ç«¯å¼€å‘æ—¥å¿—

### ğŸ“† 2025-07-25
##### âœ… **å·²å®Œæˆ**  
- åŸºç¡€åº•å›¾åŠ è½½åŠŸèƒ½  
- é«˜å¾·åœ°å›¾ä¸å¤©åœ°å›¾åº•å›¾åˆ‡æ¢  

---

### ğŸ“† 2025-07-26
##### âœ… **å·²å®Œæˆ**  
- æ˜¼å¤œæ¨¡å¼åˆ‡æ¢ï¼ˆé€šè¿‡åŒå±‚æ»¤é•œå®ç°å¤œé—´å›¾ç‰‡æ˜¾ç¤ºä¼˜åŒ–ï¼‰  
- åœ°å›¾å·¥ä½œå°é…ç½®ç»„ä»¶  
- ç”¨æˆ·ä¿¡æ¯ç»„ä»¶  
- é¡¹ç›®ä»‹ç»ç»„ä»¶  

---

### ğŸ“† 2025-07-27
##### âœ… **å·²å®Œæˆ**  
- ä½¿ç”¨ Zustand ç®¡ç†åœ°å›¾çŠ¶æ€  
- è·¯ç”±åˆ‡æ¢æ—¶è‡ªåŠ¨åŠ è½½åœ°å›¾çŠ¶æ€ 
- åœ°å›¾tableçš„æ˜¾ç¤º
- readmeæ–‡ä»¶åœ¨é¡¹ç›®é‡Œæ˜¾ç¤º

##### ğŸš§ **è¿›è¡Œä¸­**
- è°ƒè¯•å·¥å…·ç‚¹å‡»è·³è½¬å¹¶ä¸ç²¾ç¡®
- ä¹ æƒ¯ä¸€ä¸‹vimå†™ä»£ç 
##### ğŸ”„ **å¾…å®Œæˆ**
- AièŠå¤©ç•Œé¢
- ç”¨æˆ·è®¾ç½® - åœ°å›¾é€‰èŒƒå›´
- ç™»å½•ç•Œé¢
- æ³¨å†Œç•Œé¢
- åç«¯å¼€å§‹ - å‰ç«¯é›†æˆåç«¯
- æµ‹é‡åŠŸèƒ½ 
- å¯¼èˆªæ è·³è½¬
##### ğŸ” **æ€è€ƒ**
- å…·ä½“è¦å®ç°ä»€ä¹ˆåŠŸèƒ½

---

### ğŸ“† 2025-07-28
##### âœ… **å·²å®Œæˆ**  
- åŠ è½½ç‚¹å›¾å±‚ï¼ŒwhenLayerViewæ–¹æ³•
- è¦ç´ å›¾å±‚åŠ è½½ï¼ˆæ¯å¤©ä¸Šç­è¦å†™åˆ°GAé¡¹ç›®é‡Œï¼‰
  
```JavaScript
    const QueryBySql1 = () => {
        console.log("æ‰€æœ‰å­—æ®µä¿¡æ¯ä¸ºï¼š", layers[1].fields.slice(1).map(field => field.name));
        const query = layers[1].createQuery();
        query.where = "çŸ¿äº§åœ°åç§° LIKE '%é‡‘çŸ¿%'"; // åªç”¨äºæŸ¥è¯¢å‡ºå…·ä½“çš„ç»“æœï¼Œä¸ä¼šè¿”å›åˆ°åœ°å›¾ä¸Š
                /**
        * é…ç½®ç»Ÿè®¡åˆ†æå‚æ•°
        * @param statisticType ç»Ÿè®¡ç±»å‹ï¼Œæ­¤å¤„è®¾ç½®ä¸º"count"è¡¨ç¤ºè¿›è¡Œè®¡æ•°ç»Ÿè®¡
        * @param onStatisticField ç”¨äºç»Ÿè®¡çš„å­—æ®µåç§°
        * @param outStatisticFieldName è¾“å‡ºç»Ÿè®¡ç»“æœçš„å­—æ®µåç§°ï¼Œæ­¤å¤„å›ºå®šä¸º"count"
        */
        query.outStatistics = [{
            statisticType: "count",
            onStatisticField: 'çŸ¿äº§åœ°åç§°',
            outStatisticFieldName: "count"
        }];
        query.groupByFieldsForStatistics = ['çŸ¿äº§åœ°åç§°'];
        layers[1].queryFeatures(query).then(function (result) {
            const values = result.features.map(feature => feature.attributes['çŸ¿äº§åœ°åç§°']);
            console.log('å­—æœ‰å”¯ä¸€å€¼:', values);
        });
        layers[1].definitionExpression = "è§„æ¨¡ = 'å°å‹'";  // definitionExpression = ''   ä¼šç›´æ¥å°†æŸ¥è¯¢ç»“æœè¿”å›åˆ°layerä¸Š
    };
```
##### ğŸš§ **è¿›è¡Œä¸­**

##### ğŸ”„ **å¾…å®Œæˆ**
- æ·»åŠ å›¾å±‚è¿‡æ»¤ã€å­—æ®µè¡¨

##### ğŸ” **æ€è€ƒ**

---

### ğŸ“† 2025-07-29
##### âœ… **å·²å®Œæˆ**  
- åº•éƒ¨è§†å›¾å®æ—¶çŠ¶æ€
- ç™»å½•é¡µé¢
- æ§åˆ¶å°æŒ‰é’®æ’ç‰ˆ
- 
##### ğŸš§ **è¿›è¡Œä¸­**

##### ğŸ”„ **å¾…å®Œæˆ**
- å®šä½ç›¸å…³bug

##### ğŸ” **æ€è€ƒ**

---

### ğŸ“† 2025-07-30
##### âœ… **å·²å®Œæˆ**  
- é€†åœ°ç†ç¼–ç 
##### ğŸš§ **è¿›è¡Œä¸­**

##### ğŸ”„ **å¾…å®Œæˆ**

##### ğŸ” **æ€è€ƒ**

---

### ğŸ“† 2025-07-31
##### âœ… **å·²å®Œæˆ**  
- æ¡ä»¶è¿‡æ»¤

##### ğŸš§ **è¿›è¡Œä¸­**

##### ğŸ”„ **å¾…å®Œæˆ**

##### ğŸ” **æ€è€ƒ**
- å­˜åœ¨bugï¼šåˆ‡æ¢å›¾å±‚çš„æ—¶å€™è¯­å¥ä¼šé”™ä¹±

---

### ğŸ“† 2025-08-01
##### âœ… **å·²å®Œæˆ**  
- ArcGISå›¾å±‚æŒºå¥½çœ‹çš„
##### ğŸš§ **è¿›è¡Œä¸­**

##### ğŸ”„ **å¾…å®Œæˆ**

##### ğŸ” **æ€è€ƒ**

---

### ğŸ“† 2025-08-02
- ä¼˜åŒ–é€†åœ°ç†ç¼–ç é€»è¾‘ï¼Œä¾§è¾¹æ æ”¶ç¼©

---

### ğŸ“† 2025-08-11
- æ·»åŠ å›¾å±‚
  - æ”¯æŒWebURLçš„æ–¹å¼ï¼ˆgeojsonã€Esriç­‰ï¼‰
    - ä» Arcgis restfil api åˆ›å»ºä¸€ä¸ªæ–°å›¾å±‚å®ä¾‹ã€‚æ ¹æ® URLï¼Œè¿”å›çš„å›¾å±‚ç±»å‹å¯èƒ½æ˜¯ FeatureLayerã€TileLayerã€MapImageLayerã€ImageryLayerã€ImageryTileLayerã€SceneLayerã€StreamLayerã€IntegratedMeshLayerã€IntegratedMesh3DTilesLayerã€PointCloudLayerã€BuildingSceneLayerã€ElevationLayer æˆ– GroupLayerã€‚
    å‚è€ƒ[fromGeoSceneServerUrl](https://doc.geoscene.cn/javascript/4.29/api-reference/geoscene-layers-Layer.html#fromGeoSceneServerUrl) 
    - æ”¯æŒGeojson æ•°æ®æº
    - OGC WFS æ•°æ®æº
    - OGC WMS æ•°æ®æº
    - OGC WMTS æ•°æ®æº
  - æ”¯æŒæ–‡ä»¶æ·»åŠ 
    - shpæ–‡ä»¶
    - geojsonæ–‡ä»¶
    - csv
    - tif
    - csv
    - gdb
    - gbk
---

### ğŸ“† 2025-07-27

import ä¸–ç•Œ from '@/WebPublicResource/assets/scalePic/ä¸–ç•Œ.png';
import ä¹¡é•‡ from '@/WebPublicResource/assets/scalePic/ä¹¡é•‡.png';
import å…¨å›½ from '@/WebPublicResource/assets/scalePic/å…¨å›½.png';
import å¿ from '@/WebPublicResource/assets/scalePic/å¿.png';
import å¸‚ from '@/WebPublicResource/assets/scalePic/å¸‚.png';
import çœ from '@/WebPublicResource/assets/scalePic/çœ.png';
import è¡—é“ from '@/WebPublicResource/assets/scalePic/è¡—é“.png';
import DragModal from '@/WebPublicResource/components/AntdExtend/DragModal';
import { getLayerDetail } from '@/WebPublicResource/pages/Analysis/services/portalService';
import { checkPathVisible } from '@/WebPublicResource/utils/checkAuthority';
import dataTypes from '@/components/dataItemDetai_base/dataTypes';
import { getSpatialRefSysDetail } from '@/WebPublicResource/services/workstationService';
import wktParser from '@/WebPublicResource/utils/wktParser';
import {
  AimOutlined,
  FastBackwardOutlined,
  FastForwardOutlined,
  CloseOutlined,
  PlusOutlined,
  DeleteOutlined
} from '@ant-design/icons';
import _ from 'lodash'
import {
  Button,
  Collapse,
  Divider,
  InputNumber,
  Select,
  Slider,
  Tabs,
  Tooltip,
  Input,
  Space,
  AutoComplete,
} from 'antd';


import React, {
  forwardRef,
  useContext,
  useEffect,
  useImperativeHandle,
  useState,
} from 'react';
import { useModel } from 'umi';
import { WorkStationContext } from '../../WorkStationContext';
import { getDatasourceDetail } from '../../service';
import styles from './index.less';
import SQLExpression from '@/WebPublicResource/pages/Analysis/InputItems/SQLExpression';



const { Panel } = Collapse;

const LayerAttribute = (props: any, propref: any) => {
  const [activeKey, setActiveKey] = useState('1'); // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
  const [visible, setVisible] = useState(false);
  const [layer, setLayer] = useState<any>({});
  const [spatialRef, setSpatialRef] = useState<any>({});

  const [isFeature, setIsFeature] = useState(false);
  const [dataItem, setDataItem] = useState<any>(null);
  const [ds, setDs] = useState<any>({});
  const [timeFlag, setTimeFlag] = useState('');
  const [sliderValues, setSliderValues] = useState<any>([0, 6]);
  const [showScales, setShowScales] = useState<any>(['--', '--']);

  const { state } = useContext(WorkStationContext);
  const { map, view } = state;

  const [isShowPath, setIsShowPath] = useState(false);
  const { initialState }: any = useModel('@@initialState');
  // åœ¨ç»„ä»¶çŠ¶æ€éƒ¨åˆ†æ·»åŠ 
  const [fields, setFields] = useState<any[]>([]);  // è¿‡æ»¤å­—æ®µ
  const [fieldValues, setFieldValues] = useState<any[]>([]); // è¿‡æ»¤å­—æ®µæ‰€æœ‰çš„å–å€¼
  // åœ¨ç»„ä»¶çŠ¶æ€éƒ¨åˆ†æ·»åŠ 
  const [filterConnections, setFilterConnections] = useState<string[]>(['and']);
  const [filterExpression, setFilterExpression] = useState<any[][]>([['', '', null]]); // è¿‡æ»¤è¡¨è¾¾å¼
  // è¿‡æ»¤æ“ä½œç¬¦é€‰é¡¹
  const filterOperators = [
    { value: '=', label: 'ç­‰äº' },
    { value: '<>', label: 'ä¸ç­‰äº' },
    { value: '>', label: 'å¤§äº' },
    { value: '>=', label: 'å¤§äºç­‰äº' },
    { value: '<', label: 'å°äº' },
    { value: '<=', label: 'å°äºç­‰äº' },
    { value: 'like', label: 'åŒ…å«' },
    { value: 'not like', label: 'ä¸åŒ…å«' },
    { value: 'in', label: 'åœ¨åˆ—è¡¨ä¸­' },
    { value: 'not in', label: 'ä¸åœ¨åˆ—è¡¨ä¸­' },
    { value: 'is null', label: 'ä¸ºç©º' },
    { value: 'is not null', label: 'ä¸ä¸ºç©º' },
  ];

  // çº§åˆ«ä¸æ¯”ä¾‹æ˜ å°„å…³ç³»
  const levelScaleMap = [
    { level: 'ä¸–ç•Œ', scale: 100000000, image: ä¸–ç•Œ },
    { level: 'å…¨å›½', scale: 20000000, image: å…¨å›½ },
    { level: 'çœ', scale: 4000000, image: çœ },
    { level: 'å¸‚', scale: 800000, image: å¸‚ },
    { level: 'å¿', scale: 160000, image: å¿ },
    { level: 'ä¹¡é•‡', scale: 30000, image: ä¹¡é•‡ },
    { level: 'è¡—é“', scale: 5000, image: è¡—é“ },
  ];



  // åˆå§‹åŒ–è¿‡æ»¤æ¡ä»¶
  const clearAllFilterCondition = () => {
    setFilterExpression([['', '', null]])
    setFilterConnections(['and'])
    setFieldValues([])
  };

  // æ·»åŠ è¿‡æ»¤æ¡ä»¶
  const addFilterCondition = () => {
    setFilterExpression([...filterExpression, ['', '', null]]);
    // æ·»åŠ é»˜è®¤çš„è¿æ¥å…³ç³»
    setFilterConnections([...filterConnections, 'and']);
    setFieldValues([])
  };

  // åˆ é™¤è¿‡æ»¤æ¡ä»¶
  const removeFilterCondition = (index: number) => {
    if (filterConnections.length > 1) {
      setFilterExpression(prev => [...prev.slice(0, index), ...prev.slice(index + 1)]);
      setFilterConnections(prev => [...prev.slice(0, index), ...prev.slice(index + 1)]);
    }
  };

  // æ›´æ–°è¿‡æ»¤æ¡ä»¶
  const updateFilterCondition = (index, newvalue, childIndex) => {

    if (childIndex === 3) {
      const newFilterConnections = [...filterConnections];
      newFilterConnections[index - 1] = newvalue;
      setFilterConnections(newFilterConnections);
      return;
    }

    const newFilterExpression = [...filterExpression];
    newFilterExpression[index] = [...filterExpression[index]];
    newFilterExpression[index][childIndex] = newvalue;
    if (childIndex === 0) {
      newFilterExpression[index][1] = '='
      newFilterExpression[index][2] = null
    }
    setFilterExpression(newFilterExpression);
  };

  /**
 * å°†Unixæ—¶é—´æˆ³(æ¯«ç§’)è½¬æ¢ä¸ºArcGIS REST APIçš„æ—¶é—´æ ¼å¼
 * @param {number} timestamp - Unixæ—¶é—´æˆ³(æ¯«ç§’)
 * @returns {string} ArcGISæ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå¦‚ timestamp '2023-07-11 08:59:22.885'
 */
  function convertToArcGISTimeFormat(timestamp) {
    // éªŒè¯è¾“å…¥
    if (typeof timestamp !== 'number' || isNaN(timestamp)) {
      throw new Error('Invalid timestamp: must be a number');
    }

    // å¤„ç†ç§’çº§æ—¶é—´æˆ³(10ä½æ•°å­—)
    const adjustedTimestamp = timestamp.toString().length === 10 ? timestamp * 1000 : timestamp;

    // åˆ›å»ºDateå¯¹è±¡
    const date = new Date(adjustedTimestamp);

    // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
    if (isNaN(date.getTime())) {
      throw new Error('Invalid timestamp value');
    }

    // æå–å„ä¸ªæ—¶é—´ç»„ä»¶(UTCæ—¶é—´)
    const year = date.getUTCFullYear();
    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
    const day = String(date.getUTCDate()).padStart(2, '0');
    const hours = String(date.getUTCHours()).padStart(2, '0');
    const minutes = String(date.getUTCMinutes()).padStart(2, '0');
    const seconds = String(date.getUTCSeconds()).padStart(2, '0');
    const milliseconds = String(date.getUTCMilliseconds()).padStart(3, '0');

    // ç»„åˆæˆArcGISæ ¼å¼
    return `timestamp '${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}'`;
  }



  // è·å–å­—æ®µæ‰€æœ‰å€¼
  const getFieldValues = async (fieldName: string) => {
    try {
      const query = {
        returnDistinctValues: true,
        outFields: [fieldName],
        where: '1=1',
        returnGeometry: false
      }
      let values: any[] = [];
      layer.queryFeatures(query).then(function (result) {
        values = [...new Set(
          result.features.map(feature => feature.attributes[fieldName])
        )];
        // debugger
        const foundFieldtype = fields.find(item => item.name === fieldName)?.type;

        let thisfieldValues: any[] = [];
        if (foundFieldtype === 'date') {
          thisfieldValues = values.map(value => ({
            label: new Date(value).toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false // 24 å°æ—¶åˆ¶
            }), value: convertToArcGISTimeFormat(value)
          }));
        } else {
          thisfieldValues = values.map(value => ({ label: value, value: value }));
        }


        // console.log("å­—æ®µæ‰€æœ‰å€¼ï¼ˆç”±äºæ¸²æŸ“ï¼‰", thisfieldValues);
        setFieldValues(thisfieldValues);
      });
    } catch (error) {
      console.error('è·å–å­—æ®µå€¼å¤±è´¥:', error);
      setFieldValues([]);

    }
  };

  // åº”ç”¨è¿‡æ»¤
  const useFilter = () => {
    // console.log("filterExpression", filterExpression);
    if (filterExpression.length == 1 && filterExpression[0][0] == "" && filterExpression[0][2] == null) {
      layer.definitionExpression = '1=1'
      view.goTo({
        target: layer,
      })
      layer.filterExpression = filterExpression
      layer.filterConnections = filterConnections
      return;
    }
    const conditions: any = [];

    for (let i = 0; i < filterExpression.length; i++) {
      const [field, operator, value] = filterExpression[i];

      // è·³è¿‡æ— æ•ˆæ¡ä»¶ï¼ˆå­—æ®µä¸ºç©ºæˆ–æœªå®šä¹‰ï¼‰
      if (!field || field.trim() === '') continue;

      // å¤„ç†NULLç›¸å…³æ“ä½œç¬¦
      if (operator === 'IS NULL' || operator === 'IS NOT NULL') {
        conditions.push(`${field} ${operator}`);
        continue;
      }

      // è·³è¿‡æ— æ•ˆå€¼ï¼ˆå€¼ä¸ºnullæˆ–undefinedä¸”æ“ä½œç¬¦ä¸æ˜¯å¤„ç†NULLçš„ï¼‰
      if (value === null || value === undefined) continue;

      // å¤„ç†ä¸åŒæ“ä½œç¬¦
      let condition;
      switch (operator) {
        case '=':
        case '<>':
        case '>':
        case '>=':
        case '<':
        case '<=':
          // å¤„ç†æ•°å­—å’Œå­—ç¬¦ä¸²
          if (typeof value === 'number') {
            condition = `${field} ${operator} ${value}`;
          } else {

            if ((/^timestamp\s+'(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3})'$/).test(value)) {
              condition = `${field} ${operator} ${value}`;
            } else {
              // å­—ç¬¦ä¸²éœ€è¦åŠ å¼•å·å¹¶è½¬ä¹‰å•å¼•å·
              const escapedValue = String(value).replace(/'/g, "''");
              condition = `${field} ${operator} '${escapedValue}'`;
            }


          }
          break;

        case 'like':
        case 'not like':
          // LIKEæ“ä½œéœ€è¦å¤„ç†é€šé…ç¬¦
          const escapedValue = String(value).replace(/'/g, "''");
          condition = `${field} ${operator} '%${escapedValue}%'`;
          break;

        case 'in':
        case 'not in':
          // å¤„ç†æ•°ç»„å€¼
          if (Array.isArray(value)) {
            if (value.length === 0) {
              // ç©ºæ•°ç»„å¤„ç†
              condition = operator === 'in' ? '1=0' : '1=1';
            } else {
              const formattedValues = value.map(v => {
                if (typeof v === 'number' || (/^timestamp\s+'(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3})'$/).test(v)) return v;
                const escaped = String(v).replace(/'/g, "''");
                return `'${escaped}'`;
              }).join(', ');
              condition = `${field} ${operator} (${formattedValues})`;
            }
          } else {
            // éæ•°ç»„å€¼å½“ä½œå•å…ƒç´ æ•°ç»„å¤„ç†
            const formattedValue = typeof value === 'number' ? value : `'${String(value).replace(/'/g, "''")}'`;
            condition = `${field} ${operator} (${formattedValue})`;
          }
          break;

        default:
          // é»˜è®¤å¤„ç†ä¸ºç›¸ç­‰æ¯”è¾ƒ
          const defaultEscapedValue = String(value).replace(/'/g, "''");
          condition = `${field} = '${defaultEscapedValue}'`;
      }

      conditions.push(condition);
    }

    // å¦‚æœæ²¡æœ‰æ¡ä»¶ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
    if (conditions.length === 0) return;

    // ç»„åˆæ¡ä»¶
    let whereClause = '';

    for (let i = 0; i < conditions.length; i++) {
      whereClause += conditions[i];

      // æ·»åŠ è¿æ¥ç¬¦ï¼ˆå¦‚æœæœ‰ï¼‰
      if (i < conditions.length - 1 && filterConnections[i]) {
        whereClause += ` ${filterConnections[i]} `;
      }
    }
    // console.log("ç»„åˆçš„æœ€ç»ˆæ¡ä»¶", whereClause);

    layer.definitionExpression = whereClause
    view.goTo({
      target: layer,
    })
    // console.log("æœ€ç»ˆæ¡ä»¶", filterConnections, filterExpression, layer);
    layer.filterExpression = filterExpression
    layer.filterConnections = filterConnections

  }
  const fetchSpatialRefData = async () => {
    if (!layer?.spatialReference?.wkid) return;
    try {
      const res = await getSpatialRefSysDetail({ srid: layer.spatialReference.wkid });

      if (!res?.data?.[0]?.srtext) return;

      const wktResult = wktParser(res.data[0].srtext);
      const { a, rf } = wktResult || {};
      const b = rf === 0 ? null : a * (1 - 1 / rf);

      setSpatialRef(prev => ({
        ...prev,
        name: wktResult?.name,
        authority: res?.data?.[0].authName,
        unit: `${wktResult?.UNIT?.name} (${wktResult?.UNIT?.convert})`,
        majorSemiAxis: a,
        minorSemiAxis: b,
        flattening: rf,
        primeMeridian: `${wktResult?.GEOGCS?.PRIMEM?.name || wktResult?.PRIMEM?.name} (${Number(wktResult?.GEOGCS?.PRIMEM?.convert || wktResult?.PRIMEM?.convert).toFixed(2)})`,
        datumName: wktResult?.GEOGCS?.DATUM?.name || wktResult?.DATUM?.name,
        gcsName: wktResult?.ellps
      }));
    } catch (error) {
      console.error("ç©ºé—´å‚è€ƒç³»è§£æå¼‚å¸¸", error);
    }
  };

  useEffect(() => {
    if (layer && layer.spatialReference) {
      if (layer.sourceJSON?.sourceSpatialReference) {
        setSpatialRef(layer.sourceJSON?.sourceSpatialReference);
      } else if (layer.customParameters?.dataItemData) {
        getLayerDetail(layer.customParameters?.dataItemData?.id).then(
          (res: any) => {
            if (res?.sourceSpatialReference) {
              setSpatialRef(res.sourceSpatialReference);
            } else {
              setSpatialRef({});
            }
          },
        );
      } else {
        setSpatialRef({});
      }
      getDs(layer);
      if (layer.customParameters?.isDataItem) {
        let data: any;
        if (layer.customParameters?.dataItemData) {
          data = { ...layer.customParameters.dataItemData };
        }

        if (layer.customParameters?.fileData) {
          data = { ...layer.customParameters.fileData };
        }

        setDataItem({ ...data });
        if (data.startTimeField && data.endTimeField) {
          setTimeFlag('2');
        } else if (data.startTimeField) {
          setTimeFlag('1');
        } else {
          setTimeFlag('');
        }
      } else {
        setDataItem(null);
      }

      const isShowPath = checkPathVisible(
        initialState?.currentUser,
        layer.customParameters?.dataSourceInfo,
      );
      setIsShowPath(isShowPath);

      setSliderValues([0, 6]); // é»˜è®¤å€¼
      setShowScales(['--', '--']); // é»˜è®¤å€¼
      if (layer.minScale) {
        handleInputChange(layer.minScale, 0);
      }
      if (layer.maxScale) {
        handleInputChange(layer.maxScale, 1);
      }
    }
    // åœ¨ç¬¬ä¸€ä¸ªuseEffectä¸­æ·»åŠ 
    if (layer.fields) {
      setFields(layer.fields);
    }
  }, [layer]);

  useEffect(() => {
    if (map && layer) {
      fetchSpatialRefData()
      if (layer.minScale) {
        handleInputChange(layer.minScale, 0);
      }
      if (layer.maxScale) {
        handleInputChange(layer.maxScale, 1);
      }
      // å¼€å¯è¿‡æ»¤çª—å£
      console.log("å¼€å¯è¿‡æ»¤çª—å£", layer);

      setFilterConnections(layer.filterConnections || ["and"]);
      setFilterExpression(layer.filterExpression || [['', '', null]]);
    }
    return () => {
      // å¦‚æœå…³é—­ç»„ä»¶ï¼Œé‚£ä¹ˆè§¦å‘
      if (visible) {
        setActiveKey('1');
      }
    }
  }, [visible]);

  useEffect(() => {
    if (map) {
      let nlayer = map.allLayers.items.find((i) => i.id == layer.id);
      if (nlayer) {
        setLayer(nlayer);
      }
    }
  }, [map]);

  useEffect(() => {
    if (!timeFlag) {
      setDataItem({ ...dataItem, startTimeField: null, endTimeField: null });
    } else if (timeFlag == '1') {
      setDataItem({ ...dataItem, endTimeField: null });
    }
  }, [timeFlag]);

  const getDs = async (l: any) => {
    if (l.customParameters?.isDataItem) {
      setIsFeature(false);
      if (l.customParameters?.dataSourceInfo) {
        setDs(l.customParameters.dataSourceInfo);
      } else {
        let dataItemData =
          l.customParameters.dataItemData || l.customParameters.fileData;

        let res = await getDatasourceDetail(dataItemData.sourceId);
        if (res.success) {
          setDs(res.data);
        }
      }
    } else {
      setIsFeature(true);
    }
  };

  const getLayerUrl = (l: any) => {
    if (l.hasOwnProperty('layerId')) {
      return `${l.url}/${l.layerId}`;
    } else {
      return l.url;
    }
  };

  const init = (p: any) => {
    if (!layer || p.id !== layer.id || Object.keys(layer).length === 0) {
      setLayer(p);
      // æ¸…ç©ºè¿‡æ»¤æ¡ä»¶
      clearAllFilterCondition()
    }
    setVisible(true);
  };

  const checkType = (type: string, d: any, layerType: string) => {
    if (d?.id) {
      if (d.type == 'localfile') {
        return 'æ–‡ä»¶è¦ç´ ç±»';
      } else {
        return 'æ•°æ®é¡¹è¦ç´ ç±»';
      }
    }

    switch (type) {
      case 'feature':
        return 'è¦ç´ æœåŠ¡è¦ç´ ç±»';
      default:
        return layerType || '';
    }
  };

  const getDataType = (type: string) => {
    let item = dataTypes.find((i: any) => i.type == type);
    if (item) {
      return item.text;
    } else {
      return '';
    }
  };

  const getPath = () => {
    let path = ds?.path.replaceAll('\\', '/');
    if (!path.endsWith('/')) {
      path += '/';
    }
    path += dataItem.path;
    return path;
  };

  // æ ¹æ®è¾“å…¥å€¼æ‰¾åˆ°æœ€è¿‘çš„è¾ƒå°æ¯”ä¾‹å°ºç´¢å¼•
  const findNearestIndex = (value: number) => {
    let nearestIndex = 0;
    for (let i = 0; i < levelScaleMap.length; i++) {
      if (value <= levelScaleMap[i].scale) {
        nearestIndex = i;
      } else {
        break;
      }
    }
    return nearestIndex;
  };

  // å¤„ç†æ»‘å—å˜åŒ–
  const handleSliderChange = (values: any) => {
    if (values[0] != 0 || showScales[0] != '--') {
      setShowScales((prev: any) => {
        const next = [...prev];
        next[0] = levelScaleMap[values[0]].scale;
        return next;
      });
    }
    if (values[1] != 6 || showScales[1] != '--') {
      setShowScales((prev: any) => {
        const next = [...prev];
        next[1] = levelScaleMap[values[1]].scale;
        return next;
      });
    }
    setSliderValues(values);
  };

  // ç”Ÿæˆç­‰é—´è·æ»‘å—æ ‡è®°
  const marks = levelScaleMap.reduce((acc: any, cur, index) => {
    acc[index] = {
      label: <div style={{ marginTop: 20 }}>{cur.level}</div>,
    };
    return acc;
  }, {});

  // å¤„ç†è¾“å…¥æ¡†å˜åŒ–
  const handleInputChange = (value: any, index: number) => {
    if (value === null) return;
    let newIndex;
    if (value == '--' && index == 0) {
      newIndex = 0;
    } else if (value == '--' && index == 1) {
      newIndex = 6;
    } else {
      newIndex = findNearestIndex(value);
    }
    setShowScales((prev: any) => {
      const next = [...prev];
      next[index] = value;
      return next;
    });
    setSliderValues((prev: any) => {
      const next = [...prev];
      next[index] = newIndex;
      return next;
    });
  };

  const getCurrentMapScale = (index: number) => {
    if (index == 1) {
      handleInputChange(Math.floor(view.scale), index); //å‘ä¸‹å–æ•´
    } else {
      handleInputChange(Math.ceil(view.scale), index); //å‘ä¸Šå–æ•´
    }
  };

  const onSave = () => {
    layer.minScale = showScales[0];
    layer.maxScale = showScales[1];
    setVisible(false);
  };

  useImperativeHandle(propref, () => ({
    init,
    setVisible,
    switchToTab: (key, ly) => {
      setActiveKey(key);
      init(ly);
    }
  }));


  // è§£æå›¾å±‚åå­—
  const getLayerName = (item) => {
    const title = item.title;
    if (title?.[0] === '%') {
      const name = item?.sourceJSON?.name;
      if (name !== undefined && name !== null) return name;

      try {
        return decodeURIComponent(title);
      } catch (e) {
        return title;
      }
    }
    return title;
  };
  // layer.title = getLayerName(layer);
  // å»é™¤ç§‘å­¦è®¡æ•°æ³•
  const convertScientificNotation = (input) => {

    if (_.isEmpty(input)) {
      return;
    }
    const arr = input?.split(' ');
    let full;
    try {
      const fullStr = Number(arr[0])
      full = new Intl.NumberFormat('en-US', {
        useGrouping: false, // ç¦ç”¨åƒåˆ†ä½åˆ†éš”ç¬¦
        maximumFractionDigits: 40 // å…è®¸è¶³å¤Ÿå¤šçš„å°æ•°ä½
      }).format(fullStr);
    } catch (e) {
      return input;
    }

    return `${full} ${arr[1]}`;
  }


  return (
    <DragModal
      title={'å›¾å±‚å±æ€§ï¼š' + getLayerName(layer)}
      width={700}
      visible={visible}
      maskClosable={false}
      destroyOnClose={true}
      styles={{ mask: { display: 'none' } }}
      // maskStyle={{ display: 'none' }}
      wrapClassName={styles.pointerEventsNone}
      resizeable={true}
      footer={null}
      onCancel={() => setVisible(false)}
    >
      <div className={styles.layerAttribute}>
        <div
          className={styles.infos}
          style={{ width: '100%', maxHeight: '75vh' }}
        >
          <Tabs activeKey={activeKey} style={{ height: '100%' }} onChange={setActiveKey}>
            <Tabs.TabPane tab="æ•°æ®æºä¿¡æ¯" key="1" style={{ height: '100%' }}>
              <Collapse bordered={false} defaultActiveKey={['1']}>
                <Panel header="æ•°æ®æº" key="1">
                  <ul className={styles.tables}>
                    <li>
                      <div className={styles.tLabel}>æ•°æ®ç±»å‹</div>
                      <div className={styles.tValue}>
                        {checkType(layer.type, dataItem, layer?.operationalLayerType)}
                      </div>
                    </li>
                    {isFeature ? (
                      <>
                        <li>
                          <div className={styles.tLabel}>å›¾å±‚Url</div>
                          <div
                            className={styles.tValue}
                            title={getLayerUrl(layer)}
                          >
                            {getLayerUrl(layer)}
                          </div>
                        </li>
                      </>
                    ) : (
                      <>
                        <li>
                          <div className={styles.tLabel}>èµ„æºæ± </div>
                          <div className={styles.tValue} title={ds.name}>
                            {ds.name}
                          </div>
                        </li>
                        {(ds.address || ds.path) &&
                          ds.type != 'localfile' &&
                          ds.type != 'arcgisserver' && (
                            <li>
                              <div className={styles.tLabel}>èµ„æºæ± åœ°å€</div>
                              <div
                                className={styles.tValue}
                                title={ds.address || ds.path}
                              >
                                {ds.address || ds.path}
                              </div>
                            </li>
                          )}
                        {ds.type == 'arcgisserver' && (
                          <li>
                            <div className={styles.tLabel}>æœåŠ¡åœ°å€</div>
                            <div
                              className={styles.tValue}
                              title={dataItem.path}
                            >
                              {dataItem.path}
                            </div>
                          </li>
                        )}
                        {ds.type == 'localfile' && isShowPath && (
                          <li>
                            <div className={styles.tLabel}>èµ„æºåœ°å€</div>
                            <div className={styles.tValue} title={getPath()}>
                              {getPath()}
                            </div>
                          </li>
                        )}
                        {ds.port && (
                          <li>
                            <div className={styles.tLabel}>èµ„æºæ± ç«¯å£</div>
                            <div className={styles.tValue} title={ds.port}>
                              {ds.port}
                            </div>
                          </li>
                        )}
                        {ds.schema && (
                          <li>
                            <div className={styles.tLabel}>èµ„æºæ± å®ä¾‹</div>
                            <div className={styles.tValue} title={ds.schema}>
                              {ds.schema}
                            </div>
                          </li>
                        )}
                        {ds.type && (
                          <li>
                            <div className={styles.tLabel}>èµ„æºæ± ç±»å‹</div>
                            <div
                              className={styles.tValue}
                              title={getDataType(ds.type)}
                            >
                              {getDataType(ds.type)}
                            </div>
                          </li>
                        )}
                        <li>
                          <div className={styles.tLabel}>èµ„æºæ± ç”¨æˆ·</div>
                          <div
                            className={styles.tValue}
                            title={ds.userName || ds.createName}
                          >
                            {ds.userName || ds.createName}
                          </div>
                        </li>
                      </>
                    )}

                    <li>
                      <div className={styles.tLabel}>åç§°</div>
                      <div className={styles.tValue} title={getLayerName(layer)}>
                        {getLayerName(layer)}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>è¦ç´ ç±»å‹</div>
                      <div className={styles.tValue} title={layer.type}>
                        {layer.type}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>å‡ ä½•ç±»å‹</div>
                      <div
                        className={styles.tValue}
                        title={
                          layer?.geometryType ||
                          layer?.customParameters?.dataItemData?.geometryType || layer?.sourceJSON?.layers?.[0]?.geometryType || 'æ— '
                        }
                      >
                        {layer?.geometryType ||
                          layer?.customParameters?.dataItemData?.geometryType ||
                          layer?.sourceJSON?.layers?.[0]?.geometryType || "æ— "}
                      </div>
                    </li>
                    {/* <li>
                      <div className={styles.tLabel}>åæ ‡å…·æœ‰Zå€¼</div>
                      <div className={styles.tValue} title={layer.hasZ || 'æ— '}>
                        {layer.hasZ || 'æ— '}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>åæ ‡å…·æœ‰Må€¼</div>
                      <div className={styles.tValue} title={layer.hasM || 'æ— '}>
                        {layer.hasM || 'æ— '}
                      </div>
                    </li> */}
                  </ul>
                </Panel>
                <Panel header="èŒƒå›´" key="2">
                  <ul className={styles.tables}>
                    <li>
                      <div className={styles.tLabel}>ä¸Š</div>
                      <div
                        className={styles.tValue}
                        title={layer.fullExtent?.ymax}
                      >
                        {layer.fullExtent?.ymax}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>ä¸‹</div>
                      <div
                        className={styles.tValue}
                        title={layer.fullExtent?.ymin}
                      >
                        {layer.fullExtent?.ymin}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>å·¦</div>
                      <div
                        className={styles.tValue}
                        title={layer.fullExtent?.xmin}
                      >
                        {layer.fullExtent?.xmin}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>å³</div>
                      <div
                        className={styles.tValue}
                        title={layer.fullExtent?.xmax}
                      >
                        {layer.fullExtent?.xmax}
                      </div>
                    </li>
                  </ul>
                </Panel>
                <Panel header="ç©ºé—´å‚è€ƒ" key="3">
                  <ul className={styles.tables}>
                    <li>
                      <div className={styles.tLabel}>åœ°ç†åæ ‡ç³»</div>
                      <div className={styles.tValue} title={spatialRef.name || (layer?.fullExtent?.spatialReference?.isWGS84 ? 'GCS_WGS_1984' : '')}>
                        {spatialRef.name || (layer?.fullExtent?.spatialReference?.isWGS84 ? 'GCS_WGS_1984' : '')}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>WKID</div>
                      <div className={styles.tValue} title={spatialRef.wkid || layer?.spatialReference?.wkid}>
                        {spatialRef.wkid || layer?.spatialReference?.wkid}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>æˆæƒ</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.authority}
                      >
                        {spatialRef.authority}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>çº¿é•¿åº¦å•ä½</div>
                      <div className={styles.tValue} title={spatialRef.unit}>
                        {spatialRef.unit}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>æœ¬åˆå­åˆçº¿</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.primeMeridian}
                      >
                        {spatialRef.primeMeridian}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>åŸºæœ¬é¢</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.datumName}
                      >
                        {spatialRef.datumName}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>å‚è€ƒæ¤­çƒä½“</div>
                      <div className={styles.tValue} title={spatialRef.gcsName}>
                        {spatialRef.gcsName}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>é•¿åŠè½´</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.majorSemiAxis}
                      >
                        {spatialRef.majorSemiAxis}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>çŸ­åŠè½´</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.minorSemiAxis}
                      >
                        {spatialRef.minorSemiAxis}
                      </div>
                    </li>
                    <li>
                      <div className={styles.tLabel}>åæ‰ç‡</div>
                      <div
                        className={styles.tValue}
                        title={spatialRef.flattening}
                      >
                        {spatialRef.flattening}
                      </div>
                    </li>
                  </ul>
                </Panel>
                {layer.type != 'map-image' && (
                  <Panel header="å€¼åŸŸã€åˆ†è¾¨ç‡å’Œå®¹å·®" key="4">
                    <ul className={styles.tables}>
                      <li>
                        <div className={styles.tLabel}>Yæœ€å°å€¼</div>
                        <div
                          className={styles.tValue}
                          title={layer.sourceJSON?.sourceSpatialReference?.minY || layer?.fullExtent?.ymin || "æ— "}
                        >
                          {layer.sourceJSON?.sourceSpatialReference?.minY || layer?.fullExtent?.ymin || "æ— "}
                        </div>
                      </li>
                      <li>
                        <div className={styles.tLabel}>Yæœ€å¤§å€¼</div>
                        <div
                          className={styles.tValue}
                          title={layer.sourceJSON?.sourceSpatialReference?.maxY || layer?.fullExtent?.ymax || "æ— "}
                        >
                          {layer.sourceJSON?.sourceSpatialReference?.maxY || layer?.fullExtent?.ymax || "æ— "}
                        </div>
                      </li>
                      <li>
                        <div className={styles.tLabel}>Xæœ€å°å€¼</div>
                        <div
                          className={styles.tValue}
                          title={layer.sourceJSON?.sourceSpatialReference?.minX || layer?.fullExtent?.xmin || "æ— "}
                        >
                          {layer.sourceJSON?.sourceSpatialReference?.minX || layer?.fullExtent?.xmin || "æ— "}
                        </div>
                      </li>
                      <li>
                        <div className={styles.tLabel}>Xæœ€å¤§å€¼</div>
                        <div
                          className={styles.tValue}
                          title={layer.sourceJSON?.sourceSpatialReference?.maxX || layer?.fullExtent?.xmax || "æ— "}
                        >
                          {layer.sourceJSON?.sourceSpatialReference?.maxX || layer?.fullExtent?.xmax || "æ— "}
                        </div>
                      </li>
                    </ul>

                    <ul className={styles.tables} style={{ marginTop: 4 }}>
                      <li>
                        <div className={styles.tLabel}>XYåˆ†è¾¨ç‡</div>
                        <div
                          className={styles.tValue} // è§£æç§‘å­¦è®¡æ•°æ³•
                          title={
                            convertScientificNotation(layer.sourceJSON?.sourceSpatialReference
                              ?.xyResolution)

                          }
                        >
                          {convertScientificNotation(layer.sourceJSON?.sourceSpatialReference
                            ?.xyResolution)}
                        </div>
                      </li>
                    </ul>

                    <ul className={styles.tables} style={{ marginTop: 4 }}>
                      <li>
                        <div className={styles.tLabel}>XYå®¹å·®</div>
                        <div
                          className={styles.tValue}
                          title={convertScientificNotation(layer.sourceJSON?.sourceSpatialReference
                            ?.xyTolerance)

                          }
                        >
                          {
                            convertScientificNotation(layer.sourceJSON?.sourceSpatialReference
                              ?.xyTolerance)}
                        </div>
                      </li>
                    </ul>
                  </Panel>
                )}
              </Collapse>
            </Tabs.TabPane>

            <Tabs.TabPane tab="æ˜¾ç¤ºèŒƒå›´" key="2" style={{ height: '100%' }}>
              <div style={{ paddingLeft: 14 }}>
                <div style={{ padding: '0 15px 0 9px' }}>
                  <Slider
                    range
                    min={0}
                    max={levelScaleMap.length - 1}
                    value={sliderValues}
                    onChange={handleSliderChange}
                    marks={marks}
                    step={1}
                    tooltip={{
                      formatter: (val: any) => `1:${levelScaleMap[val].scale}`,
                      placement: 'bottom',
                    }}
                  />
                </div>
                <div
                  style={{
                    display: 'flex',
                    height: 68,
                    justifyContent: 'space-between',
                    margin: '80px 60px 30px 60px',
                  }}
                >
                  <div style={{ display: 'flex' }}>
                    <div>
                      <h4> çº§åˆ«ï¼š{levelScaleMap[sliderValues[0]].level} </h4>
                      <h4>
                        æ¯”ä¾‹ï¼š1:
                        <InputNumber
                          max={levelScaleMap[0].scale}
                          min={levelScaleMap[levelScaleMap.length - 1].scale}
                          value={showScales[0]}
                          controls={false}
                          onChange={(val) => handleInputChange(val, 0)}
                          style={{ width: 100, margin: '0 10px' }}
                        />
                        <Tooltip title="å½“å‰çº§åˆ«">
                          <AimOutlined
                            className={styles.setScaleIcon}
                            onClick={() => getCurrentMapScale(0)}
                          />
                        </Tooltip>
                        <Tooltip title="æœ€å¤§çº§åˆ«">
                          <FastBackwardOutlined
                            className={styles.setScaleIcon}
                            onClick={() => {
                              handleInputChange('--', 0);
                            }}
                          />
                        </Tooltip>
                      </h4>
                    </div>
                    <div style={{ marginLeft: 15 }}>
                      <img
                        src={levelScaleMap[sliderValues[0]].image}
                        alt="levelScale"
                      />
                    </div>
                  </div>
                  <Divider
                    type="vertical"
                    style={{ height: '100%', borderColor: 'var(--gabg3)' }}
                  />
                  <div style={{ display: 'flex' }}>
                    <div>
                      <h4>çº§åˆ«ï¼š{levelScaleMap[sliderValues[1]].level}</h4>
                      <h4>
                        æ¯”ä¾‹ï¼š1:
                        <InputNumber
                          max={levelScaleMap[0].scale}
                          min={levelScaleMap[levelScaleMap.length - 1].scale}
                          value={showScales[1]}
                          controls={false}
                          onChange={(val) => handleInputChange(val, 1)}
                          style={{ width: 100, margin: '0 10px' }}
                        />
                        <Tooltip title="å½“å‰çº§åˆ«">
                          <AimOutlined
                            className={styles.setScaleIcon}
                            onClick={() => getCurrentMapScale(1)}
                          />
                        </Tooltip>
                        <Tooltip title="æœ€å°çº§åˆ«">
                          <FastForwardOutlined
                            className={styles.setScaleIcon}
                            onClick={() => {
                              handleInputChange('--', 1);
                            }}
                          />
                        </Tooltip>
                      </h4>
                    </div>
                    <div style={{ marginLeft: 15 }}>
                      <img
                        src={levelScaleMap[sliderValues[1]].image}
                        alt="levelScale"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div
                style={{
                  display: 'flex',
                  justifyContent: 'end',
                  marginRight: 10,
                }}
              >
                <Button type="primary" onClick={onSave}>
                  ä¿å­˜
                </Button>
              </div>
            </Tabs.TabPane>
            {layer.fields && layer.fields.length > 0 ? (
              <Tabs.TabPane tab="å›¾å±‚è¿‡æ»¤" key="3" style={{ height: '100%' }}>
                {filterExpression.map((condition, index) => (
                  <div key={index} style={{ marginBottom: '16px' }}>
                    {index > 0 ? (
                      <Select
                        style={{ width: 80, marginRight: 8 }}
                        value={filterConnections[index - 1]}
                        onChange={(value) => {
                          updateFilterCondition(index, value, 3)
                        }}
                        options={[
                          { value: 'and', label: 'and' },
                          { value: 'or', label: 'or' }
                        ]}
                      />
                    ) : (
                      <span style={{ display: 'inline-block', width: 80, marginRight: 8, textAlign: 'right' }}>where</span>
                    )}
                    <Space>
                      <Select
                        style={{ width: 150 }}
                        placeholder="é€‰æ‹©å­—æ®µ"
                        value={condition[0]}
                        showSearch  // å…è®¸æœç´¢ï¼Œä½†ä¸å…è®¸è¾“å…¥
                        optionFilterProp="label"  // æŒ‰ label æœç´¢
                        filterOption={(input, option) =>
                          (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                        }
                        onChange={(value) => {
                          updateFilterCondition(index, value, 0);
                          setFieldValues([])
                          getFieldValues(value)
                        }}
                        options={
                          fields.map(field => ({
                            value: field.name,
                            label: field.name
                          }))
                        }
                      />

                      <Select
                        style={{ width: 110 }}
                        value={condition[1]}
                        onChange={(value) => {
                          // condition[2] = null;
                          updateFilterCondition(index, null, 2)
                          updateFilterCondition(index, value, 1)
                          // æ¸…ç©ºå³è¾¹ 
                        }}
                        options={filterOperators.filter(operator => {
                          const selectedField = fields.find(f => f.name === condition[0]);
                          if (!selectedField) return true; // å¦‚æœæ²¡æœ‰é€‰ä¸­å­—æ®µï¼Œä¿ç•™æ‰€æœ‰è¿ç®—ç¬¦
                          const operatorValue = operator.value;
                          // æ ¹æ®å­—æ®µç±»å‹è¿‡æ»¤
                          if (selectedField.type === 'string') {
                            // å­—ç¬¦ä¸²ç±»å‹ï¼šå»é™¤ >, >=, <, <=
                            return !['>', '>=', '<', '<='].includes(operatorValue);
                          } else if (selectedField.type === 'boolean') {
                            // åªä¿ç•™ç­‰äº
                            return [
                              { value: '=', label: 'ç­‰äº' }
                            ]
                          } else {
                            // éå­—ç¬¦ä¸²ç±»å‹ï¼ˆå¦‚ numberï¼‰ï¼šå»é™¤ LIKE, NOT LIKE
                            return !['like', 'not like'].includes(operatorValue);
                          }
                        })
                        }
                      />

                      {
                        !['is null', 'is not null'].includes(filterExpression[index][1]) && (
                          condition[1] === 'in' || condition[1] === 'not in' ? ( // å¤šé€‰
                            <Select
                              mode="multiple"
                              style={{ width: 200 }}
                              placeholder="é€‰æ‹©å€¼"
                              notFoundContent={"æœç´¢ä¸­..."}
                              value={condition[2] ? condition[2] : []}
                              // onFocus={() => {
                              //   // console.log("condition[2] ? condition[2] : []", condition[2] ? condition[2] : []);
                              //   getFieldValues(condition[0]);
                              // }}
                              onChange={(values) => {
                                updateFilterCondition(
                                  index,
                                  values,
                                  2
                                )
                              }}
                              options={fieldValues || []}
                            />
                          ) : ( // å•é€‰
                            <AutoComplete
                              allowClear
                              style={{ width: 200 }}
                              placeholder="è¾“å…¥æˆ–é€‰æ‹©å€¼"
                              value={condition[2]}
                              onChange={(vals) => {
                                // console.log("è¾“å…¥çš„å€¼ä¸º", vals);
                                updateFilterCondition(index, vals, 2);
                              }}
                              // onFocus={async () => {
                              //   await getFieldValues(condition[0]);
                              // }}
                              options={fieldValues || []}
                            />
                          )
                        )
                      }

                      {
                        filterExpression.length > 1 && (
                          <Button
                            icon={<CloseOutlined />}
                            onClick={() => {
                              removeFilterCondition(index)
                            }}
                          />
                        )
                      }
                    </Space>
                  </div>
                ))}
                <div style={{ padding: '16px' }}>
                  <div style={{ marginBottom: '16px', display: 'flex', gap: '10px' }}>
                    <Button
                      type="primary"
                      icon={<PlusOutlined />}
                      onClick={addFilterCondition}
                    >
                      æ·»åŠ æ¡ä»¶
                    </Button>
                    <Button
                      type="primary"
                      danger
                      icon={<DeleteOutlined />}
                      onClick={clearAllFilterCondition}
                    >
                      æ¸…ç©ºå…¨éƒ¨
                    </Button>
                  </div>
                  <div style={{ marginTop: '24px', textAlign: 'right' }}>
                    <Space>
                      <Button onClick={() => setVisible(false)}>å–æ¶ˆ</Button>
                      <Button type="primary" onClick={() => {
                        useFilter()
                        setVisible(false)
                      }}>åº”ç”¨</Button>
                    </Space>
                  </div>
                </div>
              </Tabs.TabPane>
            ) : null}


          </Tabs>
        </div>
      </div>
    </DragModal>
  );
};

const RefComponent = forwardRef(LayerAttribute);

export default RefComponent;